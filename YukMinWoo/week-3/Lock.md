# 2025-05-14 Deep Dive - Lock

---

## **InnoDB ìŠ¤í† ë¦¬ì§€ ì—”ì§„ ë ˆë²¨ ì ê¸ˆ**

<img src="./assets/photo1.png" width="100%"/>

> ğŸ’¡ **MySQL ì—”ì§„ ë ˆë²¨ ì ê¸ˆê³¼ëŠ” ë³„ê°œë¡œ ë ˆì½”ë“œ ê¸°ë°˜ ì ê¸ˆ ë°©ì‹ì„ íƒ‘ì¬í•˜ë©°  
> MyISAM ìŠ¤í† ë¦¬ì§€ ì—”ì§„ë³´ë‹¤ í›¨ì”¬ ë›°ì–´ë‚œ ë™ì‹œì„± ì²˜ë¦¬ ì œê³µ**

---

### **ë ˆì½”ë“œ ë½ (Record Lock, Record Only Lock)**

> ğŸ’¡ **ë ˆì½”ë“œ ë½ì€ ë ˆì½”ë“œ ìì²´ì—ë§Œ ê±°ëŠ” ì ê¸ˆ (INSERT, UPDATE, DELETE)**
>
> **InnoDB ìŠ¤í† ë¦¬ì§€ ì—”ì§„ ì‚¬ìš© ì‹œ, ë°ì´í„° ë³€ê²½ ì¿¼ë¦¬ë¡œ ì¸í•œ MySQL ì—”ì§„ ë ˆë²¨ ì ê¸ˆì¸ í…Œì´ë¸” ë½ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ**  
> (DML ì¿¼ë¦¬ì—ì„œëŠ” í…Œì´ë¸” ë½ì´ ë¬´ì‹œë˜ê³  DDL ì¿¼ë¦¬ì˜ ê²½ìš°ì—ë§Œ í…Œì´ë¸” ë½)
>
> **ë‹¤ë¥¸ DBMSì˜ ë ˆì½”ë“œ ë½ê³¼ ë™ì¼í•œ ì—­í• ì„ í•˜ì§€ë§Œ InnoDBì˜ ë ˆì½”ë“œ ë½ì€  
> ë ˆì½”ë“œ ìì²´ê°€ ì•„ë‹ˆë¼ ì¸ë±ìŠ¤ì˜ ë ˆì½”ë“œë¥¼ ì ê¸ˆ (ë³€ê²½ì„ ìœ„í•´ ê²€ìƒ‰í•œ ëª¨ë“  ì¸ë±ìŠ¤ì˜ ë ˆì½”ë“œì— ë½ì´ ê±¸ë¦¼)**
>
> **ì¸ë±ìŠ¤ê°€ í•˜ë‚˜ë„ ì—†ëŠ” í…Œì´ë¸”ì´ë©´ ë‚´ë¶€ì ìœ¼ë¡œ ìë™ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ë“œ ì¸ë±ìŠ¤ë¥¼ ì´ìš©í•´ ì ê¸ˆ**
>
> **PK ë˜ëŠ” ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ì— ì˜í•œ ë³€ê²½ ì‘ì—…ì€ ë ˆì½”ë“œ ë½ì„ ì‚¬ìš©í•˜ì§€ë§Œ,  
> ë³´ì¡° ì¸ë±ìŠ¤ì— ì˜í•œ ë³€ê²½ ì‘ì—…ì€ ê°­ ë½ ë˜ëŠ” ë„¥ìŠ¤íŠ¸ í‚¤ ë½ì„ ì‚¬ìš©**

---

### **ê°­ ë½ (Gap Lock)**

> ğŸ’¡ **ê°­ ë½ì€ ë ˆì½”ë“œì™€ ë°”ë¡œ ì¸ì ‘í•œ ë ˆì½”ë“œ ì‚¬ì´ì˜ ê°„ê²©ë§Œì„ ì ê¸ˆ**
>
> **ë ˆì½”ë“œì™€ ë ˆì½”ë“œ ì‚¬ì´ì˜ ê°„ê²©ì— ìƒˆë¡œìš´ ë ˆì½”ë“œê°€ INSERTë˜ëŠ” ê²ƒì„ ì œì–´í•˜ëŠ” ì—­í• **
>
> **ê°­ ë½ ìì²´ë³´ë‹¤ëŠ” ë„¥ìŠ¤íŠ¸ í‚¤ ë½ì˜ ì¼ë¶€ë¡œ ìì£¼ ì‚¬ìš©**

---

### **ë„¥ìŠ¤íŠ¸ í‚¤ ë½ (Next Key Lock)**

> ğŸ’¡ **ë„¥ìŠ¤íŠ¸ í‚¤ ë½ì€ ë ˆì½”ë“œ ë½ê³¼ ê°­ ë½ì„ í•©ì³ ë†“ì€ í˜•íƒœì˜ ì ê¸ˆ**
>
> **SQL í‘œì¤€ì—ì„œ REPEATABLE READ ê²©ë¦¬ ìˆ˜ì¤€ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” PHANTOM READ í˜„ìƒì´  
> ë„¥ìŠ¤íŠ¸ í‚¤ ë½ ë•ë¶„ì— ë°œìƒí•˜ì§€ ì•ŠìŒ**
>
> **STATEMENT í¬ë§·ì˜ ë°”ì´ë„ˆë¦¬ ë¡œê·¸ë¥¼ ì‚¬ìš©í•˜ëŠ” MySQL ì„œë²„ì—ì„œëŠ”  
> REPEATABLE READ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì‚¬ìš©í•´ì•¼ í•¨ (ê¸°ë³¸ì´ REPEATABLE READ)**
>
> **ë°”ì´ë„ˆë¦¬ ë¡œê·¸ì— ê¸°ë¡ë˜ëŠ” ì¿¼ë¦¬ê°€ ë ˆí”Œë¦¬ì¹´ ì„œë²„ì—ì„œ ì‹¤í–‰ë  ë•Œ,  
> ì†ŒìŠ¤ ì„œë²„ì—ì„œ ë§Œë“¤ì–´ ë‚¸ ê²°ê³¼ì™€ ë™ì¼í•œ ê²°ê³¼ë¥¼ ë§Œë“¤ì–´ë‚´ë„ë¡ ë³´ì¥í•˜ëŠ” ê²ƒì´ ì£¼ëª©ì **
>
> **ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ì¼ì´ ì¦ì•„ì„œ, ê°€ëŠ¥í•˜ë‹¤ë©´ ë°”ì´ë„ˆë¦¬ ë¡œê·¸ í¬ë§·ì„  
> ROW í˜•íƒœë¡œ ë°”ê¿”ì„œ ë„¥ìŠ¤íŠ¸ í‚¤ ë½ì´ë‚˜ ê°­ ë½ì„ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ìŒ (ê¸°ë³¸ì´ ROW í¬ë§·)**

---

### **ìë™ ì¦ê°€ ë½ (Auto Increment Lock)**

> ğŸ’¡ **`innodb_autoinc_lock_mode` ì‹œìŠ¤í…œ ë³€ìˆ˜ì˜ ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ìë™ ì¦ê°€ ë½ì´ ì ìš©ë¨**
>
> - `innodb_autoinc_lock_mode = 0` â†’ INSERT, REPLACE ì¿¼ë¦¬ì²˜ëŸ¼ ìƒˆë¡œìš´ ë ˆì½”ë“œë¥¼ ì €ì¥í•˜ëŠ” ì¿¼ë¦¬ì—ì„œ **í…Œì´ë¸” ìˆ˜ì¤€ì˜ ì ê¸ˆ ì‚¬ìš©**
> - `innodb_autoinc_lock_mode = 1` â†’ INSERT ë˜ëŠ” ë ˆì½”ë“œ ìˆ˜ë¥¼ **ì˜ˆì¸¡í•  ìˆ˜ ìˆìœ¼ë©´ ìë™ ì¦ê°€ ë½ ì—†ì´ ë˜ì¹˜(mutex)ë§Œ ì‚¬ìš©**
> - `innodb_autoinc_lock_mode = 2` â†’ **ìë™ ì¦ê°€ ë½ ì—†ì´ ë˜ì¹˜ë§Œ ì‚¬ìš© (ê¸°ë³¸ê°’)**

---

## ğŸ“š Ref

- Real MySQL 8.0 p.166 ~ 183
- [YouTube ê°•ì˜](https://www.youtube.com/watch?v=EBBS_giQ4AM)
- [MySQL ê³µì‹ ë¬¸ì„œ â€“ InnoDB Locking](https://dev.mysql.com/doc/refman/8.4/en/innodb-locking.html)
- [MySQL ê³µì‹ ë¬¸ì„œ â€“ Next-Key Locking](https://dev.mysql.com/doc/refman/8.4/en/innodb-next-key-locking.html)
